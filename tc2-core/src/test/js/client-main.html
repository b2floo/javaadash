<!DOCTYPE html>
<html>
    <head>
        <title> Real time multi-player games with HTML5</title>
        <meta charset="utf-8" />
        <link href="bootstrap.css" rel="stylesheet">
        
		<style>
			body { 
				padding:20px;
			}
			#console { 
				height: 400px; 
				overflow: auto; 
			}
			.username-msg {color:orange;}
			.connect-msg {color:green;}
			.disconnect-msg {color:red;}
			.send-msg {color:#888}
		</style>

        <script src="js/socket.io/socket.io.js"></script>
        <script src="js/moment.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        
        <!-- This will create a connection to socket.io, and print the user serverid that we sent from the server side. --> 
        <script type="text/javascript">
			
			var STATE_PLAYER_CHOOSE_CHARACTER = 3;
			var STATE_PLAYER_CHOOSE_ACTION = 4;
			var STATE_PLAYER_CHOOSE_DISCARD = 6;
			
			console.log( 'javascript -- start' );
			var username = 'user' + Math.floor((Math.random()*1000)+1);
			
           //This is all that needs
           var socket = io.connect('http://localhost:9092', {
             'reconnection delay' : 2000,
             'force new connection' : true
           });
           
           socket.on('connect', function() {
       		    console.log( 'Connected...' );
                // connection established, now we can send an objects
       		});
       		
       		$(window).load(function(){ 
       			output('<span class="username-msg">Welcome '+username+'!</span>');
       		})
       		
       		function joinAnyGame() {
                var jsonObject = {username: username};
            	socket.emit('join_any_game', jsonObject);
			};
			
			socket.on('start_game', function(data) {
				output('<span class="username-msg">Starting a game with '+data.opponent+'!</span>');

				output('<span class="username-msg">Available characters: </span>');
				outputCardList(data.myCharacters);
				output('<span class="username-msg">Available cards: </span>');
				outputCardList(data.myHand);
				output('<span class="username-msg">Opponent characters: </span>');
				outputCardList(data.myOpponentCharacters);
				var characterCard = { 'characterCard' : data.myCharacters[0].id, 
				 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseCharacterMessage'};
				socket.emit('choose_character', characterCard);
				var actionCards = { 'actionCards' : [data.myHand[0]], 
				 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseActionMessage'};
				socket.emit('choose_action', actionCards);
       		});
       		
       		socket.on('update_game', function(data) {
                output('<span class="username-msg">Update after turn</span>');

                output('<span class="username-msg">Available characters: </span>');
                outputCardList(data.myCharacters);
                output('<span class="username-msg">Available cards: </span>');
                outputCardList(data.myHand);
                output('<span class="username-msg">Opponent characters: </span>');
                outputCardList(data.myOpponentCharacters);
                
                // choose a card to discard
                if(data.gameState == STATE_PLAYER_CHOOSE_CHARACTER) {
	                var characterCard = { 'characterCard' : data.myCharacters[0].id, 
					 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseCharacterMessage'};
					socket.emit('choose_character', characterCard);
					var actionCards = { 'actionCards' : [data.myHand[0]], 
				 	'@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseActionMessage'};
					socket.emit('choose_action', actionCards);
                } else if(data.gameState == STATE_PLAYER_CHOOSE_DISCARD) {
	                var discardCards = { 'discardCards' : [data.myHand[0]], 
	                 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseDiscardMessage'};
	                socket.emit('choose_discard', discardCards);
                }
            });
            
            socket.on('end_game', function(data) {
                output('<span class="username-msg">GAME OVER</span>');

                output('<span>Winner is: '+data.winner+' </span>');
                output('<span>Your score is: '+data.myScore+' </span>');
                output('<span>Opponent score is: '+data.myOpponentScore+' </span>');
            });


			function output(message) {
	            var currentTime = "<span class='time'>" +  moment().format('HH:mm:ss.SSS') + "</span>";
	            var element = $("<div>" + currentTime + " " + message + "</div>");
				$('#console').append(element);
			}

            function outputCardList(cards) {
              for(var i=0; i<cards.length; ++i) {
                  output('Card ID: '+ cards[i].id + '; LIFE: '+ cards[i].settings['LIFE']);
              }    
            }

			
        </script>
 
    </head>
 
    <body>
        <!--<canvas id="canvas"> </canvas>  -->
        <h1>netty-socketio demo</h1>
	
		<br/>
	
	    <form class="well form-inline" onsubmit="return false;">
	       <!--<input id="username" class="input-xlarge" type="text" placeholder="Enter your name--"/>-->
	       <button type="button" onClick="joinAnyGame()" class="btn">Join any game</button>
	    </form>
	    
	    <div id="console" class="well">
    </body>
</html>