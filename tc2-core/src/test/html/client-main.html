<!DOCTYPE html>
<html>
    <head>
        <title> Real time multi-player games with HTML5</title>
        <meta charset="utf-8" />
		<!-- JQuery -->
		<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
		
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        
		<style>
			body { 
				padding:20px;
			}
			#console { 
				height: 100px; 
				overflow: auto; 
			}
			.username-msg {color:orange;}
			.connect-msg {color:green;}
			.disconnect-msg {color:red;}
			.send-msg {color:#888}
		</style>
		
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

		<script src="js/socket.io/socket.io.js"></script>
        <script src="js/moment.min.js"></script>
		
	
	<!-- This will create a connection to socket.io --> 
        <script type="text/javascript">
			
			STATE_BEGIN_GAME = 0;
			STATE_PLAYER_CHOOSE_CHARACTER = 3;
			STATE_PLAYER_CHOOSE_ACTION = 4;
			STATE_PLAYER_CHOOSE_DISCARD = 6;
			
			gameState = STATE_BEGIN_GAME;
			
			console.log( 'javascript -- start' );
			
           //This is all that needs
           var socket = io.connect('http://localhost:9092', {
             'reconnection delay' : 2000,
             'force new connection' : true
           });
           
           socket.on('connect', function() {
       		    console.log( 'Connected...' );
                // connection established, now we can send an objects
       		});
       		
       		function joinAnyGame() {
       		    var username = $('#username').val();
                var jsonObject = {username: username};
            	socket.emit('join_any_game', jsonObject);
			};
			
			socket.on('start_game', function(data) {
				output('<span class="username-msg">Starting a game with '+data.opponent+'!</span>');

				output('<span class="username-msg">Available characters: </span>');
				outputCardList(data.myCharacters);
                for(var i=0; i<data.myCharacters.length; ++i) {
                    displayCard("#myCharacter"+(i+1), data.myCharacters[i].id, 'right');
                } 

				output('<span class="username-msg">Available cards: </span>');
				outputCardList(data.myHand);

				output('<span class="username-msg">Opponent characters: </span>');
				outputCardList(data.myOpponentCharacters);
                for(var i=0; i<data.myOpponentCharacters.length; ++i) {
                    displayCard("#opponentCharacter"+(i+1), data.myOpponentCharacters[i].id, 'left');
                } 

				gameState = STATE_PLAYER_CHOOSE_CHARACTER;

				//var actionCards = { 'actionCards' : [data.myHand[0]], 
				// '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseActionMessage'};
				//socket.emit('choose_action', actionCards);
       		});
       		
       		socket.on('update_game', function(data) {
                output('<span class="username-msg">Update :: turn '+data.turn+'</span>');

                output('<span class="username-msg">Available characters: </span>');
                outputCardList(data.myCharacters);
				for(var i=0; i<data.myCharacters.length; ++i) {
                    displayCard("#myCharacter"+(i+1), data.myCharacters[i].id, 'right');
                } 
				
                output('<span class="username-msg">Available cards: </span>');
                outputCardList(data.myHand);
				
                output('<span class="username-msg">My board: </span>');
                outputCardList(data.myBoard);
				
                output('<span class="username-msg">My discard: </span>');
                outputCardList(data.myDiscard);
				
                output('<span class="username-msg">Opponent characters: </span>');
                outputCardList(data.myOpponentCharacters);
				for(var i=0; i<data.myOpponentCharacters.length; ++i) {
                    displayCard("#opponentCharacter"+(i+1), data.myOpponentCharacters[i].id, 'left');
                } 
				
                output('<span class="username-msg">Opponent board: </span>');
                outputCardList(data.myOpponentBoard);
				
                output('<span class="username-msg">Opponent discard: </span>');
                outputCardList(data.myOpponentDiscard);
				
                // choose a card to discard
                if(data.gameState == STATE_PLAYER_CHOOSE_CHARACTER) {
	                var characterCard = { 'characterCard' : data.myCharacters[0].id, 
					 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseCharacterMessage'};
					socket.emit('choose_character', characterCard);
					var actionCards = { 'actionCards' : [data.myHand[0]], 
				 	'@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseActionMessage'};
					socket.emit('choose_action', actionCards);
                } else if(data.gameState == STATE_PLAYER_CHOOSE_DISCARD) {
	                var discardCards = { 'discardCards' : [data.myHand[0]], 
	                 '@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseDiscardMessage'};
	                socket.emit('choose_discard', discardCards);
                }
            });
            
            socket.on('end_game', function(data) {
                output('<span class="username-msg">GAME OVER</span>');

                output('<span>Winner is: '+data.winner+' </span>');
                output('<span>Your score is: '+data.myScore+' </span>');
                output('<span>Opponent score is: '+data.myOpponentScore+' </span>');
            });


			function output(message) {
	            var currentTime = "<span class='time'>" +  moment().format('HH:mm:ss.SSS') + "</span>";
	            var element = $("<div>" + currentTime + " " + message + "</div>");
				$('#console').append(element);
			}

            function outputCardList(cards) {
              for(var i=0; i<cards.length; ++i) {
                  output('Card ID: '+ cards[i].id + '; LIFE: '+ cards[i].settings['LIFE'] + '; Available: '+cards[i].available);
              }    
            }

            function displayCard(elementId, cardId, popoverPlacement) {
                $(elementId).attr("data-trigger", "hover");             
                $(elementId).attr("data-toggle", "popover");
                $('img',elementId).attr("src", "images/"+cardId+"_small.png") ;
				$(elementId).attr("data-cardid", cardId) ;
                $(elementId).popover({
                    placement : popoverPlacement,
                    content: '<img src="images/'+cardId+'.png">', 
                    html:true,
					delay: {
							 show: 700,
							 hide: 100
					}
                });
            }

			$(document).ready(function() {
                output('Welcome!');
				$('.tc2_myCharacterThumbnail').popover({
						placement : 'right',
						content: popoverCardImage, 
						html:true,
						delay: { 
							 show: 500, 
							 hide: 100
					}
				});		
			});

			function popoverCardImage() {
				var popoverImageSrc = $('img',this).attr("data-popover");
				return '<img src="'+popoverImageSrc+'">';
			}
			
			function selectCharacter(linkElement) {
				if(gameState == STATE_PLAYER_CHOOSE_CHARACTER) {
					// check existing card in place
					var selectedCharacterIndex = $('#mySelectedCharacter').attr("data-character-index");
					if(typeof selectedCharacterIndex !== 'undefined') {
						displayCard('#'+selectedCharacterIndex, $('#mySelectedCharacter').attr("data-cardid"), 'right');
                        $('#mySelectedCharacter').popover('destroy');
					}
					var selectedCardId = $(linkElement).attr("data-cardid");
                    // add a timeout as the popover.destroy is asynchronous
                    setTimeout(function () {
                        displayCard('#mySelectedCharacter', selectedCardId, 'right');
                    ;}, 200);
					$('#mySelectedCharacter').attr("data-character-index", $(linkElement).attr("id"));
					// set clicked link to no-card
					$(linkElement).removeAttr("data-trigger"); 
					$(linkElement).removeAttr("data-toggle");
					$(linkElement).removeAttr("data-cardid") ;
                    $(linkElement).popover('destroy');
					$('img',linkElement).attr("src", "images/0000.png");
				}
			}
			
			function finishStep() {
				if(gameState == STATE_PLAYER_CHOOSE_CHARACTER) {
					var selectedCardId = $('#mySelectedCharacter').attr("data-cardid");
					if(typeof selectedCardId == 'undefined') {
						output('<span class="disconnect-msg">You must select a character first!</span>');
					} else {
						var characterCard = { 'characterCard' : selectedCardId, 
						'@class' : 'com.javaadash.tc2.core.interfaces.message.ChooseCharacterMessage'};
						socket.emit('choose_character', characterCard);
					}
				}
			}
        </script>
    </head>
 
     <body>
        <div class="container">
            <div class="row">
	            <form class="well form-inline col-lg-4 col-md-4 col-sm-4" onsubmit="return false;">
	               <input id="username" class="input-xlarge" type="text" placeholder="Enter your name--"/>
	               <button type="button" onClick="joinAnyGame()" class="btn">Join any game</button>
	            </form>

                <div id="console" class="well col-lg-7 col-md-7 col-sm-7 pull-right"></div>
            </div>
        </div>

        <div class="container">
            <div class="panel panel-default">
              <div class="panel-body">
                <div class="row">
                    <!-- My characters -->
                    <div class="col-lg-2 col-md-2 col-sm-2">
                        <div class="panel panel-default">
                            <div class="panel-heading">My characters</div>
                            <div class="panel-body">
								<a id="myCharacter1" href="#" class="thumbnail" onclick="selectCharacter(this)">
									<img src="images/0000.png">
								</a>
				                <a id="myCharacter2" href="#" class="thumbnail" onclick="selectCharacter(this)">
									<img src="images/0000.png">
				                </a>
				                <a id="myCharacter3" href="#" class="thumbnail" onclick="selectCharacter(this)">
				                  <img src="images/0000.png">
				                </a>
			                </div>
                        </div>
                    </div>
                    <!-- My actions -->
                    <div class="col-lg-2 col-md-2 col-sm-2">
                        <div class="panel panel-default">
                            <div class="panel-heading">My actions</div>
                                <div class="panel-body">
									<a data-toggle="popover" data-trigger="hover" class="thumbnail tc2_myCharacterThumbnail">
									  <img src="images/card1_small.png" data-popover="images/card1.png">
									</a>
									<a data-toggle="popover" data-trigger="hover" class="thumbnail tc2_myCharacterThumbnail">
									  <img src="images/card1_small.png" data-popover="images/card1.png">
									</a>
									<a data-toggle="popover" data-trigger="hover" class="thumbnail tc2_myCharacterThumbnail">
									  <img src="images/card1_small.png" data-popover="images/card1.png">
									</a>
									<a data-toggle="popover" data-trigger="hover" class="thumbnail tc2_myCharacterThumbnail">
									  <img src="images/card1_small.png" data-popover="images/card1.png">
									</a>
									<a data-toggle="popover" data-trigger="hover" class="thumbnail tc2_myCharacterThumbnail">
									  <img src="images/card1_small.png" data-popover="images/card1.png">
									</a>
                                </div>
                            </div>
                        </div>
						<!-- Main game panel -->
						<div class="col-lg-6 col-md-6 col-sm-6">
							<div class="well">
								<button type="button" onClick="finishStep()" class="btn btn-danger"><span class="glyphicon glyphicon-fast-forward"></span> Play</button>
							</div>
							<div class="panel panel-primary">
								<div class="panel-body" style="height:600px">
									<div class="panel panel-primary" style="border: 10px solid transparent;">
										<div class="panel-heading">Played characters</div>
										<div class="panel-body">
											<div class="row">
												<a id="mySelectedCharacter" class="thumbnail pull-left">
												  <img src="images/0000.png">
												</a>
												<a id="opponentSelectedCharacter" class="thumbnail pull-right">
												  <img src="images/0000.png">
												</a>
											</div>
										</div>
									</div>
									<div class="panel panel-primary" style="border: 10px solid transparent;">
										<div class="panel-heading">Played actions</div>
										<div class="panel-body">
											<div class="row">
												<a class="thumbnail pull-left">
												  <img src="images/0000.png">
												</a>
												<a class="thumbnail pull-left">
												  <img src="images/0000.png">
												</a>
												<a class="thumbnail pull-right">
												  <img src="images/0000.png">
												</a>
												<a class="thumbnail pull-right">
												  <img src="images/0000.png">
												</a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
                        <!-- Opponents characters -->
                        <div class="col-lg-2 col-md-2 col-sm-2 pull-right">
                            <div class="panel panel-default">
                                <div class="panel-heading">Opponents characters</div>
                                <div class="panel-body">
								    <a id="opponentCharacter1" href="#" class="thumbnail">
									    <img src="images/0000.png">
								    </a>
				                    <a id="opponentCharacter2" href="#" class="thumbnail">
				                      <img src="images/0000.png">
				                    </a>
				                    <a id="opponentCharacter3" href="#" class="thumbnail">
				                      <img src="images/0000.png">
				                    </a>
			                    </div>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        </div>
        		
    </body>
</html>
